# -*- coding: utf-8 -*-
#
# This file is part of the ZPEnergy project
#
#
#
# Distributed under the terms of the GPL license.
# See LICENSE.txt for more info.

""" Zone plate energy motor

This device implements zone plate positioning for the selected energy.
"""

# PyTango imports
import tango
from tango import DebugIt
from tango.server import run
from tango.server import Device
from tango.server import attribute, command
from tango.server import device_property
from tango import AttrQuality, DispLevel, DevState
from tango import AttrWriteType, PipeWriteType
# Additional import
# PROTECTED REGION ID(ZPEnergy.additionnal_import) ENABLED START #
from scipy.constants import c, elementary_charge
from tango import Database
Planck = 4.136*10**(-15)
# PROTECTED REGION END #    //  ZPEnergy.additionnal_import

__all__ = ["ZPEnergy", "main"]


class ZPEnergy(Device):
    """
    This device implements zone plate positioning for the selected energy.

    **Properties:**

    - Device Property
        zp_tango_motor
            - Tango device of the ZP motor
            - Type:'DevString'
        zp_unit_coeff
            - ZP unit coefficient:\n[microns] = [motor_units] * zp_unit_coeff
            - Type:'DevDouble'
        dial_offset
            - Type:'DevDouble'
    """
    # PROTECTED REGION ID(ZPEnergy.class_variable) ENABLED START #
    def calc_focus(self, zp_diam, zone_width, enrg):
        # Calculates the focal distance for the given energy, ZP diam, and the outer zone width #
        try:
            focus = (enrg * zp_diam * zone_width) / (Planck * (c * 1 * 10**6))
            print('calc_focus() call', focus)
            return focus
        except Exception as e:
            print('calc_focus failed', e)
            focus = 0
        return focus

    def calc_energy(self, focus, zp_diam, zone_width):
        try:
            energy = (Planck * (c * 1 * 10**6) * focus) / (zp_diam * zone_width) # all should be in microns, including the c
            #print('calc_energy() call, energy:', energy)
            return energy
        except Exception as e:
            print (e)
            return 0

    def calc_a1(self, zp_diam, zone_width, energy=700):
        focal_dist = self.calc_focus(zp_diam, zone_width, energy)
        a1 = focal_dist / energy
        print(f'zp_diam: {zp_diam}, zone_width: {zone_width}, energy: {energy}')
        print(f'Calculated focal distance at {energy} eV is: {focal_dist}')
        print(f'Calculated A1 is: {a1}')
        return a1

    def read_attr_hardware(self, attrs):
        self.__dial_pos = (self.zp_dev.Position - self.dial_offset) * self.zp_unit_coeff

    # PROTECTED REGION END #    //  ZPEnergy.class_variable

    # -----------------
    # Device Properties
    # -----------------

    zp_tango_motor = device_property(
        dtype='DevString',
        default_value="B318A/CTL/DUMMY-01"
    )

    zp_unit_coeff = device_property(
        dtype='DevDouble',
        default_value=1000
    )

    dial_offset = device_property(
        dtype='DevDouble',
        default_value=0.0
    )

    # ----------
    # Attributes
    # ----------

    DialPos = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        display_level=DispLevel.EXPERT,
        unit="micron",
        memorized=True,
    )

    Energy = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        unit="eV",
        memorized=True,
        hw_memorized=True,
    )

    UserPos = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        unit="micron",
        memorized=True,
    )

    ZP_A0 = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        display_level=DispLevel.EXPERT,
        unit="micron",
        memorized=True,
    )

    ZP_A1 = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        display_level=DispLevel.EXPERT,
        memorized=True,
        hw_memorized=True,
    )

    ZP_Diam = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        display_level=DispLevel.EXPERT,
        unit="micron",
        memorized=True,
        hw_memorized=True,
    )

    ZP_width = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        display_level=DispLevel.EXPERT,
        memorized=True,
        hw_memorized=True,
    )

    Defocus = attribute(
        dtype='DevDouble',
        access=AttrWriteType.READ_WRITE,
        unit="micron",
        memorized=True,
    )

    # ---------------
    # General methods
    # ---------------

    def init_device(self):
        """Initialises the attributes and properties of the ZPEnergy."""
        Device.init_device(self)
        # PROTECTED REGION ID(ZPEnergy.init_device) ENABLED START #
        try:
            prop_names = ['Energy', 'DialPos', 'ZP_A0', 'ZP_A1']
            self.db = Database()
            props = self.db.get_device_attribute_property(self.get_name(), prop_names)
        except BaseException as e:
            print(e)
            print('Problem extracting the previous values from the database!')

        self.__energy = float(props['Energy']['__value'][0])
        # self.__user_pos = 0.0
        self._zp__a0 = float(props['ZP_A0']['__value'][0])
        self._zp__a1 = float(props['ZP_A1']['__value'][0])
        self._zp__diam = 0.0
        self._zp_width = 0.0
        self.__dial_pos = 0.0
        self.__defocus = 0.0

        self._calc_a1 = 0.0

        try:
            self.zp_dev = tango.DeviceProxy(self.zp_tango_motor)
            print('motor position at the beginning is:', self.zp_dev.Position)
            print('motor position at the beginning with the dial offset (position + dial_offset):', self.zp_dev.Position + self.dial_offset)
        except BaseException as e:
            print(e)
            self.set_state(DevState.FAULT)

        self.set_state(DevState.ON)
        # PROTECTED REGION END #    //  ZPEnergy.init_device

    def always_executed_hook(self):
        """Method always executed before any TANGO command is executed."""
        # PROTECTED REGION ID(ZPEnergy.always_executed_hook) ENABLED START #
        # self._calc_a1 = self.calc_a1(self._zp__diam, self._zp_width)
        # PROTECTED REGION END #    //  ZPEnergy.always_executed_hook

    def delete_device(self):
        """Hook to delete resources allocated in init_device.

        This method allows for any memory or other resources allocated in the
        init_device method to be released.  This method is called by the device
        destructor and by the device Init command.
        """
        # PROTECTED REGION ID(ZPEnergy.delete_device) ENABLED START #
        # PROTECTED REGION END #    //  ZPEnergy.delete_device
    # ------------------
    # Attributes methods
    # ------------------

    def read_DialPos(self):
        # PROTECTED REGION ID(ZPEnergy.DialPos_read) ENABLED START #
        """Return the DialPos attribute."""
        return self.__dial_pos
        # PROTECTED REGION END #    //  ZPEnergy.DialPos_read

    def write_DialPos(self, value):
        # PROTECTED REGION ID(ZPEnergy.DialPos_write) ENABLED START #
        """Set the DialPos attribute."""
        self.zp_dev.Position = value / self.zp_unit_coeff + self.dial_offset
        self.__user_pos = value - self._zp__a0 - self.__defocus
        self.db.put_device_attribute_property(self.get_name(), {'DialPos': {'DialPos': value}})
        # PROTECTED REGION END #    //  ZPEnergy.DialPos_write

    def read_Energy(self):
        # PROTECTED REGION ID(ZPEnergy.Energy_read) ENABLED START #
        """Return the Energy attribute."""
        try:
            #energy = self.calc_energy(self.__user_pos * -1, self._zp__diam, self._zp_width)
            self.__energy = self.__user_pos / self._zp__a1 * -1
            return self.__energy
        except Exception as e:
            print('Error in read_Energy', e)
            return 0

        # PROTECTED REGION END #    //  ZPEnergy.Energy_read

    def write_Energy(self, value):
        # PROTECTED REGION ID(ZPEnergy.Energy_write) ENABLED START #
        """Set the Energy attribute."""
        self.__user_pos = self._zp__a1 * value * -1
        self.zp_dev.Position = (self.__user_pos + self._zp__a0 + self.__defocus) / self.zp_unit_coeff + self.dial_offset
        self.__energy = value
        # PROTECTED REGION END #    //  ZPEnergy.Energy_write

    def read_UserPos(self):
        # PROTECTED REGION ID(ZPEnergy.UserPos_read) ENABLED START #
        """Return the UserPos attribute."""
        return self.__user_pos
        # PROTECTED REGION END #    //  ZPEnergy.UserPos_read

    def write_UserPos(self, value):
        # PROTECTED REGION ID(ZPEnergy.UserPos_write) ENABLED START #
        """Set the UserPos attribute."""
        self.zp_dev.Position = (value + self._zp__a0 + self.__defocus) / self.zp_unit_coeff + self.dial_offset
        self.__user_pos = value
        self.db.put_device_attribute_property(self.get_name(), {'UserPos': {'UserPos': value}})
        # PROTECTED REGION END #    //  ZPEnergy.UserPos_write

    def read_ZP_A0(self):
        # PROTECTED REGION ID(ZPEnergy.ZP_A0_read) ENABLED START #
        """Return the ZP_A0 attribute."""
        return self._zp__a0
        # PROTECTED REGION END #    //  ZPEnergy.ZP_A0_read

    def write_ZP_A0(self, value):
        # PROTECTED REGION ID(ZPEnergy.ZP_A0_write) ENABLED START #
        """Set the ZP_A0 attribute."""
        self.zp_dev.Position = (self.__user_pos + value + self.__defocus) / self.zp_unit_coeff + self.dial_offset
        self._zp__a0 = value
        # PROTECTED REGION END #    //  ZPEnergy.ZP_A0_write

    def read_ZP_A1(self):
        # PROTECTED REGION ID(ZPEnergy.ZP_A1_read) ENABLED START #
        """Return the ZP_A1 attribute."""
        return self._zp__a1
        # PROTECTED REGION END #    //  ZPEnergy.ZP_A1_read

    def write_ZP_A1(self, value):
        # PROTECTED REGION ID(ZPEnergy.ZP_A1_write) ENABLED START #
        """Set the ZP_A1 attribute."""
        self._zp__a1 = value
        # PROTECTED REGION END #    //  ZPEnergy.ZP_A1_write

    def read_ZP_Diam(self):
        # PROTECTED REGION ID(ZPEnergy.ZP_Diam_read) ENABLED START #
        """Return the ZP_Diam attribute."""
        return self._zp__diam
        # PROTECTED REGION END #    //  ZPEnergy.ZP_Diam_read

    def write_ZP_Diam(self, value):
        # PROTECTED REGION ID(ZPEnergy.ZP_Diam_write) ENABLED START #
        """Set the ZP_Diam attribute."""
        self._zp__diam = value
        # PROTECTED REGION END #    //  ZPEnergy.ZP_Diam_write

    def read_ZP_width(self):
        # PROTECTED REGION ID(ZPEnergy.ZP_width_read) ENABLED START #
        """Return the ZP_width attribute."""
        return self._zp_width
        # PROTECTED REGION END #    //  ZPEnergy.ZP_width_read

    def write_ZP_width(self, value):
        # PROTECTED REGION ID(ZPEnergy.ZP_width_write) ENABLED START #
        """Set the ZP_width attribute."""
        self._zp_width = value
        # PROTECTED REGION END #    //  ZPEnergy.ZP_width_write

    def read_Defocus(self):
        # PROTECTED REGION ID(ZPEnergy.Defocus_read) ENABLED START #
        """Return the Defocus attribute."""
        return self.__defocus
        # PROTECTED REGION END #    //  ZPEnergy.Defocus_read

    def write_Defocus(self, value):
        # PROTECTED REGION ID(ZPEnergy.Defocus_write) ENABLED START #
        """Set the Defocus attribute."""
        self.zp_dev.Position = (self.__user_pos + self._zp__a0 + value) / self.zp_unit_coeff + self.dial_offset
        self.__defocus = value

        # PROTECTED REGION END #    //  ZPEnergy.Defocus_write

    # --------
    # Commands
    # --------

    @command(
        dtype_out='DevString',
        display_level=DispLevel.EXPERT,
    )
    @DebugIt()
    def Calc_A1(self):
        # PROTECTED REGION ID(ZPEnergy.Calc_A1) ENABLED START #
        """
        Calculates and substitutes the current A1 parameter based on the given ZP parameters.

        :return:None
        """
        self._zp__a1 = self.calc_a1(self._zp__diam, self._zp_width)
        return str(self._zp__a1)
        # PROTECTED REGION END #    //  ZPEnergy.Calc_A1

# ----------
# Run server
# ----------


def main(args=None, **kwargs):
    """Main function of the ZPEnergy module."""
    # PROTECTED REGION ID(ZPEnergy.main) ENABLED START #
    return run((ZPEnergy,), args=args, **kwargs)
    # PROTECTED REGION END #    //  ZPEnergy.main


if __name__ == '__main__':
    main()
